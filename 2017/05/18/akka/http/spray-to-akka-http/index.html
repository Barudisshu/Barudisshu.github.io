<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Migrating from Spray to Akka</title><link rel="stylesheet" href="/css/layout.css">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css"><link rel="shortcut icon" href="/img/favicon.ico"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">简单易懂の现代魔法</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="http://weibo.com/u/2360401155" class="menu-link">Weibo</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li><li class="menu-item"><a href="/atom.xml" class="menu-link">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">简单易懂の现代魔法</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="http://weibo.com/u/2360401155" class="menu-link">Weibo</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li><li class="menu-item"><a href="/atom.xml" class="menu-link">Rss</a></li></ul></nav><div id="mobile-menu-toggle" class="toggle-menu"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Migrating from Spray to Akka</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2017-05-18</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a href="/tags/akka/" class="tag-link">akka</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a href="/categories/akka-http/" class="category-link">akka-http</a></p></div><div class="article-content"><p>Spray is a well-known HTTP library in the Scala ecosystem. It was released in 2011, and since then it’s been widely used by the Scala community. It was recently announced that Spray would be replaced with Akka HTTP, thus cementing Akka HTTP as the successor of Spray. It’s maintained by Lightbend and it’s been recommended that users migrate to it soon.</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>However, migration from one major version of a library to another is not an easy task. Very often it requires you to spend some time reading the source code in order to figure out how to use certain features, as well as how to migrate existing logic.</p>
<p>This post will demonstrate what changes should be applied in order to migrate your app from Spray to Akka HTTP. The following steps don’t have a particular order, as it depends on which areas need to be rewritten.</p>
<a id="more"></a>
<h2><span id="packages">Packages</span></h2>
<p>In order to have the lastest Akka HTTP packages, all previous Spray dependencies now need to be replaced by the following:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"com.typesafe.akka" %% "akka-http-core" % “2.4.3”</span><br><span class="line">"com.typesafe.akka" %% "akka-http-experimental" % “2.4.3”</span><br><span class="line">"com.typesafe.akka" %% "akka-http-testkit" % “2.4.3” % "test"</span><br></pre></td></tr></table></figure>
<h2><span id="httpservice">HttpService</span></h2>
<p>Spray’s HttpService has been removed. Use Http class and pass your routes to the bindAndHandle method. For example:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val service = system.actorOf(Props(new HttpServiceActor(routes)))</span><br><span class="line">IO(Http)(system) ! Http.Bind(service, "0.0.0.0", port = 8080)</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Http().bindAndHandle(routes, "0.0.0.0", port = 8080)</span><br></pre></td></tr></table></figure>
<h2><span id="marshalling">Marshalling</span></h2>
<p><code>Marshaller.of</code> can be replaced with <code>Marshaller.withFixedContentType</code>. See below:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Marshaller.of[JsonApiObject](`application/vnd.api+json`) &#123; (value, contentType, ctx) =&gt;</span><br><span class="line">      ctx.marshalTo(HttpEntity(contentType, value.toJson.toString))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Marshaller.withFixedContentType(`application/vnd.api+json`) &#123; obj =&gt;</span><br><span class="line">      HttpEntity(`application/vnd.api+json`, obj.toJson.compactPrint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Akka HTTP marshallers support content negotiation, so you don’t have to specify the content type when creating one “super” marshaller from other marshallers:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ToResponseMarshaller.oneOf(</span><br><span class="line">      `application/vnd.api+json`,</span><br><span class="line">      `application/json`</span><br><span class="line">    )(</span><br><span class="line">      jsonApiMarshaller,</span><br><span class="line">      jsonMarshaller</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Marshaller.oneOf(</span><br><span class="line">      jsonApiMarshaller,</span><br><span class="line">      jsonMarshaller</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h2><span id="unmarshalling">Unmarshalling</span></h2>
<p>The example below shows one way that an Unmarshaller might be rewritten:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Unmarshaller[Entity](`application/vnd.api+json`) &#123;</span><br><span class="line">      case HttpEntity.NonEmpty(contentType, data) =&gt;</span><br><span class="line">data.asString.parseJson.convertTo[Entity]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unmarshaller.stringUnmarshaller.forContentTypes(`application/vnd.api+json`).map(_.parseJson.convertTo[Entity])</span><br></pre></td></tr></table></figure>
<h2><span id="mediatypes">MediaTypes</span></h2>
<p><code>MediaType.custom</code> can be replaced with specific methods in <code>MediaType</code> object.</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MediaType.custom("application/vnd.acme+json")</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MediaType.applicationWithFixedCharset("application/vnd.acme+json", HttpCharsets.`UTF-8`)</span><br></pre></td></tr></table></figure>
<h2><span id="rejection-handling">Rejection Handling</span></h2>
<p>RejectionHandler now uses a builder pattern – see the example below:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def rootRejectionHandler = RejectionHandler &#123;</span><br><span class="line">    case Nil =&gt; &#123;</span><br><span class="line">      requestUri &#123; uri =&gt;</span><br><span class="line">        logger.error("Route: &#123;&#125; does not exist.", uri)</span><br><span class="line">        complete((NotFound, mapErrorToRootObject(notFoundError)))</span><br><span class="line">      &#125;</span><br><span class="line"> case AuthenticationFailedRejection(cause, challengeHeaders) :: _ =&gt; &#123;</span><br><span class="line">      logger.error(s"Request is rejected with cause: $cause")</span><br><span class="line">      complete((Unauthorized, mapErrorToRootObject(unauthenticatedError)))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RejectionHandler</span><br><span class="line">    .newBuilder()</span><br><span class="line">    .handle &#123;</span><br><span class="line">      case AuthenticationFailedRejection(cause, challengeHeaders) =&gt;</span><br><span class="line">        logger.error(s"Request is rejected with cause: $cause")</span><br><span class="line">        complete((Unauthorized, mapErrorToRootObject(unauthenticatedError)))</span><br><span class="line">.handleNotFound &#123; ctx =&gt;</span><br><span class="line">      logger.error("Route: &#123;&#125; does not exist.", ctx.request.uri.toString())</span><br><span class="line">      ctx.complete((NotFound, mapErrorToRootObject(notFoundError)))</span><br><span class="line">    &#125;</span><br><span class="line">.result() withFallback RejectionHandler.default</span><br></pre></td></tr></table></figure>
<h2><span id="client">Client</span></h2>
<p>The Spray-client pipeline was removed. Use Http’s singleRequest method instead:</p>
<p>Before:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val pipeline: HttpRequest =&gt; Future[HttpResponse] = (addHeader(Authorization(OAuth2BearerToken(accessToken))) ~&gt; sendReceive)</span><br><span class="line"> val patch: HttpRequest = Patch(uri, object))</span><br><span class="line"></span><br><span class="line">pipeline(patch).map &#123; response ⇒</span><br><span class="line">	…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">val request = HttpRequest(</span><br><span class="line">                method = PATCH,</span><br><span class="line">                uri = Uri(uri),</span><br><span class="line">                headers = List(Authorization(OAuth2BearerToken(accessToken))),</span><br><span class="line">                entity = HttpEntity(MediaTypes.`application/json`, object)</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line">              http.singleRequest(request).map &#123;</span><br><span class="line">			case … =&gt; …</span><br><span class="line">			… </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="headers">Headers</span></h2>
<p>All HTTP headers have been moved to the akka.http.scaladsl.model.headers._ package.</p>
<p>Form fields and file upload</p>
<p>With the streaming nature of http entity, it’s important to have a strict http entity before accessing multiple form fields or use file upload directives. One solution might be using next directive before working with form fields:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val toStrict: Directive0 = extractRequest flatMap &#123; request =&gt;</span><br><span class="line">      onComplete(request.entity.toStrict(5.seconds)) flatMap &#123;</span><br><span class="line">        case Success(strict) =&gt;</span><br><span class="line">          mapRequest( req =&gt; req.copy(entity = strict))</span><br><span class="line">        case _ =&gt; reject</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>And one can use it like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">toStrict &#123;</span><br><span class="line">	formFields("name".as[String]) &#123; name =&gt;</span><br><span class="line">		... </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>While this list isn’t an exhaustive collection of all the changes you need to do, it covers the trickiest ones that exist. One major drawback of Akka HTTP is that it’s not as mature as Spray, and it’s performance is not optimised yet. Users may also notice a lack of documentation for some cases.</p>
<p>Having said that, it would be a good idea to keep the above issues in mind during this process. Happy migration!</p>
</div></article><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2017/05/18/akka/http/spray-to-akka-http/';
var disqus_title = 'Migrating from Spray to Akka';
var disqus_url = 'http://galudisu.info/2017/05/18/akka/http/spray-to-akka-http/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//barudisshu-github-io.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2019 <a href="http://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready"><script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css"><script src="/js/base.js"></script><script src="/js/rabbit-lyrics.js"></script></div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --></body></html>
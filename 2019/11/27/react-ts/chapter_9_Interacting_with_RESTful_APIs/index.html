<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第九章 RESTful 接口交互</title><link rel="stylesheet" href="/css/layout.css">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css"><link rel="shortcut icon" href="/img/favicon.ico"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">简单易懂の现代魔法</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="http://weibo.com/u/2360401155" class="menu-link">Weibo</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li><li class="menu-item"><a href="/atom.xml" class="menu-link">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">简单易懂の现代魔法</a></li><li class="menu-item"><a href="/archives/" class="menu-link">Archives</a></li><li class="menu-item"><a href="http://weibo.com/u/2360401155" class="menu-link">Weibo</a></li><li class="menu-item"><a href="/about" class="menu-link">About</a></li><li class="menu-item"><a href="/atom.xml" class="menu-link">Rss</a></li></ul></nav><div id="mobile-menu-toggle" class="toggle-menu"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第九章 RESTful 接口交互</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-11-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tags"> </i><a href="/tags/react/" class="tag-link">react<span class="tag">, </span></a><a href="/tags/typescript/" class="tag-link">typescript</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a href="/categories/react/" class="category-link">react</a></p></div><div class="article-content"><ul>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><li>Writing asynchronous code</li>
<li>Using fetch</li>
<li>Using axios with class components</li>
<li>Using axios with function components</li>
</ul>
<h2><span id="writing-asynchronous-code">Writing asynchronous code</span></h2>
<p>默认下TypeScript的代码是同步执行的。既是一行一行代码执行。TypeScript也可以实现异步功能。调用REST API就是一个异步实现的例子。</p>
<h3><span id="callbacks">Callbacks</span></h3>
<p>回调指的是将函数作为参数，传入到一个异步函数中调用，当该异步函数完成时执行该传参函数的内容。</p>
<h3><span id="callback-execution">Callback execution</span></h3>
<p>下面以一个例子阐述在TypeScript环境下的异步回调实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> firstName: <span class="built_in">string</span>;</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  firstName = <span class="string">"Fred"</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"firstName in callback"</span>, firstName);</span><br><span class="line">&#125;,<span class="number">1000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"firstName aftr setTimeout"</span>, firstName);</span><br></pre></td></tr></table></figure>
<p>代码中调用了JavaScript的异步函数<code>setTimeout</code>。第一个参数是一个回调函数，第二个参数是执行等待的时间。</p>
<p>这里的回调函数，形式上使用<code>() =&gt;{}</code> 表述，回调函数会将<code>firstName</code>变量更改为<code>Fred</code>，并输出到控制台。</p>
<p>执行代码，可以看到回调函数并没有执行，而是等待1000毫秒后再触发控制台打印信息。</p>
<p>异步函数的执行不会等待函数内部的完成。这种方式一方面不便于阅读，另一方面容易造成回调地狱(callback hell)。因为开发者容易在回调中内嵌更复杂的回调或异步函数实现。那么我们如何处理这种异步回调的错误？</p>
<h3><span id="handling-callback-erros">Handling callback erros</span></h3>
<p>本小节将探索如何处理异步代码的错误信息。</p>
<ol>
<li>首先有如下代码：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  setTimeout(() =&gt; &#123;</span><br><span class="line">    throw new Error(&quot;Someting went wrong&quot;);</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">&#125; catch (ex) &#123;</span><br><span class="line">  console.log(&quot;An error has occurred&quot;, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次使用了<code>try / catch</code>方式来处理异步出现的错误信息。</p>
<ol start="2">
<li>错误信息必须被处理。更改为：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">interface IResult &#123;</span><br><span class="line">  success: boolean;</span><br><span class="line">  error?: any;</span><br><span class="line">&#125;</span><br><span class="line">let result: IResult = &#123; success: true &#125;;</span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    throw new Error(&quot;Something went wrong&quot;);</span><br><span class="line">  &#125; catch (ex) &#123;</span><br><span class="line">    result.success = false;</span><br><span class="line">    result.error = ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, 1000);</span><br><span class="line">console.log(result);</span><br></pre></td></tr></table></figure>
<p>这里将<code>try / catch</code>放置在回调函数的内部。以及使用了变量<code>result</code>来表述执行的成功或失败。</p>
<p>至此，回调引发的错误已经被处理了。幸运的是，有更好的方式来处理这种挑战。</p>
<h2><span id="promises">Promises</span></h2>
<p>promise是JavaScript里面的对象。它表述了一个异步操作的最终结果(成功或失败).</p>
<h3><span id="consuming-a-promised-based-function">Consuming a promised-based function</span></h3>
<p>下面是一个promised-based的API</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">.then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">.catch(<span class="function"><span class="params">json</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"error"</span>, json));</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的函数<code>fetch</code>是javascript本地函数，用于处理RESTful API。</li>
<li>入参是一个URL</li>
<li><code>then</code>方法处理返回</li>
<li><code>catch</code>方法处理错误信息</li>
</ul>
<p>相比来说代码更易于阅读和理解。我们不需要在<code>then</code>方法中处理错误信息。</p>
<h3><span id="creating-a-promised-based-function">Creating a promised based function</span></h3>
<p>本小节会创建一个<code>wait</code>函数来处理异步等待信息。</p>
<ol>
<li>首先实现一个简单的回调：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wait = <span class="function">(<span class="params">ms: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ms &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">      reject(<span class="string">"Too long"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">"Successfully waited"</span>);</span><br><span class="line">    &#125;, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数返回一个<code>Promise</code>对象，该对象包含有一个需要异步执行的构造器入参。</li>
<li><code>promise</code>构造入参<code>resolve</code>是一个函数，表示当函数执行完成后要处理的动作。</li>
<li><code>promise</code>构造入参<code>reject</code>是一个函数，表示出现错误后需要处理的动作。</li>
<li>函数体内部则使用了<code>setTimeout</code>以及一个回调处理等待动作。</li>
</ul>
<ol start="2">
<li>消费这个<code>promised-based</code>函数：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wait(<span class="number">500</span>)</span><br><span class="line">.then(<span class="function"><span class="params">result</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"then &gt;"</span>, result))</span><br><span class="line">.then(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"catch &gt;"</span>, error));</span><br></pre></td></tr></table></figure>
<p>等待500毫秒后，函数将输出正确或失败信息。</p>
<ol start="3">
<li>将等待时间延长，大于1000，<code>catch</code>方法被调用。</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wait(<span class="number">1500</span>)</span><br><span class="line">.then(<span class="function"><span class="params">result</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"then &gt;"</span>, result))</span><br><span class="line">.then(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"catch &gt;"</span>, error));</span><br></pre></td></tr></table></figure>
<p><code>Promise</code>对于异步代码有一个很好的处理机制。致辞，还有另一种异步处理的实现方式。</p>
<h2><span id="async-and-awit">async and awit</span></h2>
<p><code>async</code>和<code>await</code>是JavaScript的关键字。</p>
<ol>
<li>首先从<code>wait</code>函数的例子开始：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someWork = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> wait(<span class="number">500</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">someWork();</span><br></pre></td></tr></table></figure>
<ul>
<li>这里创建了一个箭头函数<code>someWork</code>，使用关键字<code>async</code>标注为异步。</li>
<li>使用关键字<code>await</code>在<code>wait</code>前面声明。<code>wait</code>下一行的执行将被暂停(halt)直到这个异步操作完成。</li>
<li><code>try / catch</code>将捕获任何异常信息。</li>
</ul>
<p>该方法有点像是一个异步操作的管理者。执行代码后，控制台打印：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">then &gt; Successfully waited</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将等待时间改为1500毫秒：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> wait(<span class="number">1500</span>);</span><br></pre></td></tr></table></figure>
<p>控制台打印错误信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Too long</span><br></pre></td></tr></table></figure>
<p>因此，使用<code>async</code>和<code>await</code>使得代码更易于阅读。另一个奖励是，这种实现在旧的浏览器中仍然支持。</p>
<p>到目前为止，我们已经对如何编写更好的异步代码有更好的理解，下面会就RESTful API的实现进行练习。</p>
<h2><span id="using-fetch">Using fetch</span></h2>
<p><code>fetch</code>函数是一个JavaScript本地函数。本小节会对一些常见的RESTful API通过<code>fetch</code>进行交互。</p>
<h3><span id="geting-data-with-fetch">Geting data with fetch</span></h3>
<p>首先开始从GET请求开始。</p>
<h3><span id="baisc-get-request">Baisc GET request</span></h3>
<p>打开 TypeScript playground，输入如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">.then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data))</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>fetch</code>函数的第一个参数是一个URL请求地址</li>
<li><code>fetch</code>是一个promised-base函数</li>
<li>第一个<code>then</code>方法处理返回</li>
<li>第二个<code>then</code>方法处理当返回body是JSON</li>
</ul>
<h3><span id="getting-response-status">Getting response status</span></h3>
<p>通常，我们需要处理返回的status code：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status, respons.ok);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>返回的<code>status</code>给出了HTTP的状态信息</li>
<li><code>ok</code>返回一个<code>boolean</code>值表示200的状态码</li>
</ul>
<p>另一个404的不存在的示例如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts/1001"</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status, response.ok);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3><span id="handling-errors">Handling errors</span></h3>
<p>通过<code>catch</code>方法处理错误信息：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">.then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">.catch(<span class="function"><span class="params">json</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"error"</span>, json));</span><br></pre></td></tr></table></figure>
<p>然而，<code>catch</code>并没有捕获非200状态的机制。所以对于非200的错误返回请求时，可以在第一个<code>then</code>方法中处理。</p>
<p>那么<code>catch</code>方法是干嘛的？它是用来捕获网络异常的，非200返回并不是一种网络异常。</p>
<h3><span id="creating-data-with-fetch">Creating data with fetch</span></h3>
<p>本小节将使用<code>fetch</code>来创建一些数据。</p>
<h3><span id="basic-post-request">Basic POST request</span></h3>
<p>通常情况下，调用<code>post</code>请求来创建数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>, &#123;</span><br><span class="line">  method: <span class="string">"POST"</span>,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">    title: <span class="string">"Interesting post"</span>,</span><br><span class="line">    body: <span class="string">"This si an interesting post abount ..."</span>,</span><br><span class="line">    userId: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status);</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data));</span><br></pre></td></tr></table></figure>
<p><code>fetch</code>函数的第二个参数是一个可选对象。包含请求的method和body信息。</p>
<h3><span id="request-http-headers">Request HTTP headers</span></h3>
<p>通常，请求信息需要包含标头(header)。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts"</span>, &#123;</span><br><span class="line">  method: <span class="string">"POST"</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">    Authorization: <span class="string">"bearer some-bearer-token"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">    title: <span class="string">"Interesting post"</span>,</span><br><span class="line">    body: <span class="string">"This is an interesting post about ..."</span>,</span><br><span class="line">    userId: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status);</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data));</span><br></pre></td></tr></table></figure>
<p>对于<code>GET</code>请求，可以用如下形式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts/1"</span>, &#123;</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">    Authorization: <span class="string">"bearer some-bearer-token"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).then(...);</span><br></pre></td></tr></table></figure>
<h3><span id="changing-data-with-fetch">Changing data with fetch</span></h3>
<h3><span id="basic-put-request">Basic PUT request</span></h3>
<p>通常情况下，对于数据的更改是用<code>PUT</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts/1"</span>, &#123;</span><br><span class="line">  method: <span class="string">"PUT"</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">    title: <span class="string">"Corrected post"</span>,</span><br><span class="line">    body: <span class="string">"This is corrected post about ..."</span>,</span><br><span class="line">    userId: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status);</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data));</span><br></pre></td></tr></table></figure>
<h3><span id="basic-patch-request">Basic PATCH request</span></h3>
<p>某些情况下，<code>PATCH</code>的请求用于部分请求的更改。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts/1"</span>, &#123;</span><br><span class="line">  method: <span class="string">"PATCH"</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">"Content-type"</span>: <span class="string">"application/json"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">    title: <span class="string">"Corrected post"</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status);</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">&#125;).then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data));</span><br></pre></td></tr></table></figure>
<h3><span id="deleting-data-with-fetch">Deleting data with fetch</span></h3>
<p>通常情况下，RESTful接口都是用<code>DELETE</code>方法删除数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"https://jsonplaceholder.typicode.com/posts/1"</span>, &#123;</span><br><span class="line">  method: <span class="string">"DELETE"</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.status);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>到目前为止，我们已经学习了如何使用<code>fetch</code>函数来操作RESTful API。</p>
<h2><span id="using-axios-with-class-components">Using axios with class components</span></h2>
<p><code>axios</code>是一个流行的开源JavaScript HTTP客户端。我们会创建一个React App包含有create,read,upate,delete等操作。并探索<code>axios</code>相比<code>fetch</code>有哪些优势。</p>
<h3><span id="installing-axios">Installing axios</span></h3>
<p>首先新建一个应用：</p>
<ol>
<li>在控制台通过命令新建一个TypeScript的React项目：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app crud-api --typescript</span><br></pre></td></tr></table></figure>
<p>注意我们使用的React版本至少是<code>16.7.0-alpha.0</code>。我们可以在<code>package.json</code>里面检查。如果低于<code>16.7.0-alpha.0</code>，可以使用下面命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install react@16.7.0-alpha.0</span><br><span class="line">npm install react@16.7.0-alpaha.0</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>项目创建后，添加TSLint到项目中，并带有某些规则：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd crud-api</span><br><span class="line">npm install tslint tslint-react tslint-config-prettier --save-dev</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>新建<code>tslint.json</code>包含下面规则：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "extends": ["tslint:recommended", "tslint-react", "tslint-config-prettier"],</span><br><span class="line">  "rules": &#123;</span><br><span class="line">    "ordered-imports": false,</span><br><span class="line">    "object-literal-sort-keys": false,</span><br><span class="line">    "jsx-no-lambda": false,</span><br><span class="line">    "no-debugger": false,</span><br><span class="line">    "no-console": false,</span><br><span class="line">  &#125;,</span><br><span class="line">  "linterOptions": &#123;</span><br><span class="line">    "exclude": [</span><br><span class="line">      "config/**/*.js",</span><br><span class="line">      "node_modules/**/*.ts",</span><br><span class="line">      "converage/lcov-report/*.js"</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>打开<code>App.tsx</code>文件，会有一个linting错误。在<code>render()</code>方法中添加<code>public</code>关键字处理该问题：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">    public render() &#123;</span><br><span class="line">        return ( ... );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加<code>axios</code>：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios</span><br></pre></td></tr></table></figure>
<p>注意<code>axios</code>内已经包含TypeScript类型了，不需要额外安装。</p>
<ol start="6">
<li>运行我们的应用。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>
<h3><span id="getting-data-with-axios">Getting data with axios</span></h3>
<h3><span id="basic-get-request">Basic GET request</span></h3>
<p>首先从GET请求开始。</p>
<ol>
<li>打开<code>App.tsx</code>，导入：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import axios from &quot;axios&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建接口类型，表示JSONPlaceholder返回的内容：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface IPost &#123;</span><br><span class="line">    userId: number;</span><br><span class="line">    id?: number;</span><br><span class="line">    title: string;</span><br><span class="line">    body: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>我们需要存储上述的邮件信息到state中，因此添加下面这个接口：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface IState &#123;</span><br><span class="line">    posts: IPost[];</span><br><span class="line">&#125;</span><br><span class="line">class App extends React.Component&lt;&#123;&#125;, IState&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在构造器生命周期中初始化state：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component&lt;&#123;&#125;, IState&gt; &#123;</span><br><span class="line">    public constructor(props: &#123;&#125;) &#123;</span><br><span class="line">        super(props);</span><br><span class="line">        this.state = &#123;</span><br><span class="line">            posts: []</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>通常是在<code>componentDidMount</code>生命周期函数中获取REST API数据。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public componentDidMount() &#123;</span><br><span class="line">    axios</span><br><span class="line">    .get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;)</span><br><span class="line">    .then(response =&gt; &#123;</span><br><span class="line">        this.setState(&#123; posts: response.data &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这是使用<code>get</code>函数表述<code>GET</code>请求，它跟<code>fetch</code>一样，是一个promised-based函数。</li>
<li>这里是一个泛型函数，泛型参数为返回消息数据类型。</li>
<li>URL地址作为传入参数。</li>
<li>在<code>then</code>方法处理返回信息。</li>
<li>通过<code>data</code>对象属性获取请求的返回对象。</li>
</ul>
<p>因此，相比<code>fetch</code>有两点好处：</p>
<ul>
<li>可以定义返回的数据类型</li>
<li>只需要一步即可获取返回体</li>
</ul>
<ol start="6">
<li>在<code>render</code>方法渲染：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public render() &#123;</span><br><span class="line">    return (</span><br><span class="line">        &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">            &lt;url className=&quot;posts&quot;&gt;</span><br><span class="line">                &#123;this.state.posts.map(post =&gt; (</span><br><span class="line">                    &lt;li key=&#123;post.id&#125;&gt;</span><br><span class="line">                        &lt;h3&gt;&#123;post.title&#125;&lt;/h3&gt;</span><br><span class="line">                        &lt;p&gt;&#123;post.body&#125;&lt;/p&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                ))&#125;</span><br><span class="line">            &lt;/url&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用<code>posts</code>数组的<code>map</code>函数来展现数据。</p>
<ol start="7">
<li>在<code>index.css</code>添加CSS属性，</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.posts</span> &#123;</span><br><span class="line">    <span class="attribute">list-style</span>: none;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0px</span> auto;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">800px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，使用<code>axios</code>来处理请求更简单方便。以及我们需要在<code>componentDidMount</code>生命周期函数中调用。</p>
<p>那么对于网络错误如何处理？</p>
<h3><span id="handling-errors">Handling errors</span></h3>
<ol>
<li>首先添加一个错误的URL，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/postsX&quot;)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>我们希望出现网络错误的情况下，依然给用户以反馈内容。可以用<code>catch</code>方法：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">  .get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/postsX&quot;)</span><br><span class="line">  .then( ... )</span><br><span class="line">  .catch(ex =&gt; &#123;</span><br><span class="line">        const error = </span><br><span class="line">        ex.response.status === 404 ? &quot;Resource not found&quot; : &quot;An unexpected error has occurred&quot;;</span><br><span class="line">        this.setState(&#123; error &#125;);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>和<code>fetch</code>不同，HTTP status错误返回码可以在<code>catch</code>方法处理。错误信息包含有一个属性<code>response</code>表示请求的返回内容。</p>
<ol start="3">
<li>另外修改该部分渲染，我们希望将错误信息显示出来：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">interface IState &#123;</span><br><span class="line">    posts: IPost[];</span><br><span class="line">    error: string;</span><br><span class="line">&#125;</span><br><span class="line">class App extends React.Component&lt;&#123;&#125;, IState&gt; &#123;</span><br><span class="line">    public constructor(props: &#123;&#125;) &#123;</span><br><span class="line">        super(props);</span><br><span class="line">        this.state = &#123;</span><br><span class="line">            posts: [],</span><br><span class="line">            error: &quot;&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>渲染错误内容：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul className=&quot;posts&quot;&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&#123;this.state.error &amp;&amp; &lt;p className=&quot;error&quot;&gt;&#123;this.state.error&#125;&lt;/p&gt;&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加错误的样式：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.error</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次执行应用，可以看到红色的 <strong>Resource not found</strong> 字体。</p>
<ol start="6">
<li>将URL更改为原来有效的地址，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;)</span><br></pre></td></tr></table></figure>
<h3><span id="request-http-headers">Request Http headers</span></h3>
<p>有时候我们希望带上header请求信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">        &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>因此，我们在HTTP请求时定义了<code>headers</code>属性。</p>
<h3><span id="timeouts">Timeouts</span></h3>
<p>超时机制用于提高用户体验。</p>
<ol>
<li>在我们的app添加一个请求超时：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">        &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    timeout: 1</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里的单位是毫秒。表示期望请求在1毫秒内做出响应。</p>
<ol start="2">
<li>在<code>catch</code>方法处理超时：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.catch(ex =&gt; &#123;</span><br><span class="line">    const error = </span><br><span class="line">          ex.code === &quot;ECONNABORTED&quot;</span><br><span class="line">    	? &quot;A timeout has occurred&quot;</span><br><span class="line">    	: ex.response.status === 404 </span><br><span class="line">    		? &quot;Resource not found&quot;</span><br><span class="line">    		: &quot;An unexpected error has occurred&quot;;</span><br><span class="line">    this.setState(&#123; error &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>我们检测<code>code</code>属性来判断是否发生了超时。</p>
<p>再次执行应用，可以看到红色<strong>A timeout has occurred</strong>字体。</p>
<ol start="3">
<li>将超时更改为合适的值。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">    ...</span><br><span class="line">    timeout: 5000</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3><span id="canceling-requests">Canceling requests</span></h3>
<p>允许用户取消请求可以提升用户体验效果。</p>
<ol>
<li>首先，导入<code>CancelTokenSource</code>类型：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import axios, &#123; CancelTokenSource &#125; from &quot;axios&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加 cancel token和加载flag到state中：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface IState &#123;</span><br><span class="line">  posts: IPost[];</span><br><span class="line">  error: string;</span><br><span class="line">  cancelTokenSource?: CancelTokenSource;</span><br><span class="line">  loading: boolean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在构造器初始化：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">this.state = &#123;</span><br><span class="line">  posts: [],</span><br><span class="line">  error: &quot;&quot;,</span><br><span class="line">  loading: true</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在<code>GET</code>请求之前，生成token资源：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public componentDidMount() &#123;</span><br><span class="line">  const cancelToken = axios.CancelToken;</span><br><span class="line">  const cancelTokenSource = cancelToken.source();</span><br><span class="line">  this.setState(&#123; cancelTokenSource &#125;);</span><br><span class="line">  axios</span><br><span class="line">    .get&lt;IPost[]&gt;(...)</span><br><span class="line">    .then(...)</span><br><span class="line">    .catch(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>然后在GET请求中使用这个token：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">  cancelToken: cancelTokenSource.token,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>我们可以在<code>catch</code>方法处理取消的情况。并设置<code>loading</code>状态为<code>false</code>：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.catch((ex) =&gt; &#123;</span><br><span class="line">  const error =</span><br><span class="line">    ex.code === &quot;ECONNABORTED&quot;</span><br><span class="line">      ? &quot;A timeout has occurred&quot;</span><br><span class="line">      : ex.response.status === 404</span><br><span class="line">      ? &quot;Resource not found&quot;</span><br><span class="line">      : &quot;An unexpected error has occurred&quot;;</span><br><span class="line">  this.setState(&#123; error &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>因此我们使用<code>axios</code>里面的<code>isCancel</code>函数来检测请求是否已经被取消。</p>
<ol start="7">
<li>在<code>componentDidMount</code>方法里面，在<code>then</code>方法设置<code>loading</code>的状态为<code>false</code>：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.then(response =&gt; &#123;</span><br><span class="line">    this.setState(&#123; posts: response.data, loading: false &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>在<code>render</code>方法中，添加一个<code>Cancel</code>按钮，允许用户取消请求：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;this.state.loading &amp;&amp; (</span><br><span class="line">    &lt;button onClick=&#123;this.handleCancelClick&#125;&gt;Cancel&lt;/button&gt;</span><br><span class="line">)&#125;</span><br><span class="line">&lt;url className=&quot;posts&quot;&gt;...&lt;/url&gt;</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>实现取消处理：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private handleCancelClick = () =&gt; &#123;</span><br><span class="line">    if (this.state.cancelTokenSource) &#123;</span><br><span class="line">        this.state.cancelTokenSource.cancel(&quot;User cancelled operation&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>现在有点难测，因为请求一般很快。为了可以看到取消请求的动作。我们可以在<code>componentDidMount</code>方法内立即取消请求动作：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">  .get&lt;IPost[]&gt;(...)</span><br><span class="line">  .then(response =&gt; &#123;...&#125;)</span><br><span class="line">  .catch(ex =&gt; &#123;...&#125;);</span><br><span class="line">cancelTokenSource.cancel(&quot;User cancelled operation&quot;);</span><br></pre></td></tr></table></figure>
<p>回到浏览器可以看到红色字体的<strong>Request cancelled</strong>字样。</p>
<h3><span id="creating-data-with-axios">Creating data with axios</span></h3>
<p>使用POST请求创建数据：</p>
<ol>
<li>首先添加状态属性：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface IState &#123;</span><br><span class="line">    ...</span><br><span class="line">    editPost: IPost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在构造器初始化：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public constructor(props: &#123;&#125;) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">    this.state = &#123;</span><br><span class="line">        ...,</span><br><span class="line">        editPost: &#123;</span><br><span class="line">          body: &quot;&quot;,</span><br><span class="line">          title: &quot;&quot;,</span><br><span class="line">          userId: 1</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建表单内容：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=&quot;App&quot;&gt;</span><br><span class="line">    &lt;div className=&quot;post-eidt&quot;&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">            type=&quot;text&quot;</span><br><span class="line">            placeholder=&quot;Enter title&quot;</span><br><span class="line">            value=&#123;this.state.editPost.title&#125;</span><br><span class="line">            onChange=&#123;this.handleTitleChange&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">        &lt;textarea</span><br><span class="line">            placeholder=&quot;Enter body&quot;</span><br><span class="line">            value=&#123;this.state.editPost.body&#125;</span><br><span class="line">            onChange=&#123;this.handleBodyChange&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">        &lt;button onClick=&#123;this.handleSaveClick&#125;&gt;Save&lt;/button&gt;</span><br><span class="line">        &#123;this.state.loading &amp;&amp; (</span><br><span class="line">            &lt;button onClick=&#123;this.handleCancelClick&#125;&gt;Cancel&lt;/button&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">        ...</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>下面是对状态的更新处理：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private handleTitleChange = (e: React.ChangeEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">        editPost: &#123;</span><br><span class="line">            ...this.state.editPost,</span><br><span class="line">            title: e.currentTarget.value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">private handleBodyChange = (e: React.ChangeEvent&lt;HTMLTextAreaElement&gt;) =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">        editPost: &#123;</span><br><span class="line">            ...this.state.editPost,</span><br><span class="line">            body: e.currentTarget.value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>在<code>index.css</code>中添加一些CSS样式让它看起来更合理：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.post-edit</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">textarea</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>然后在点击时，触发<code>POST</code>请求：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private handleSaveClick = () =&gt; &#123;</span><br><span class="line">    axios</span><br><span class="line">      .post&lt;IPost&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">        body: this.state.editPost.body,</span><br><span class="line">        title: this.state.editPost.title,</span><br><span class="line">        userId: this.state.editPost.userId</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">            &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ).then(response =&gt; &#123;</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">            posts: this.state.posts.concat(response.data)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>post</code>函数的结构和<code>get</code>非常相似。实际上，可以像<code>get</code>方法一样，添加错误处理、超时、取消等动作。</p>
<h3><span id="updating-data-with-axios">Updating data with axios</span></h3>
<p>我们希望用户可以点击<strong>Update</strong>按钮来更新数据。</p>
<ol>
<li>首先创建一个<code>Update</code>按钮。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;li key=&#123;post.id&#125;&gt;</span><br><span class="line">  &lt;h3&gt;&#123;post.title&#125;&lt;/h3&gt;</span><br><span class="line">  &lt;p&gt;&#123;post.body&#125;&lt;/p&gt;</span><br><span class="line">  &lt;button onClick=&#123;() =&gt; this.handleUpdateClick(post)&#125;&gt;</span><br><span class="line">    Update</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>实现<strong>Update</strong>按钮的事件处理：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private handleUpdateClick = (post:IPost) =&gt; &#123;</span><br><span class="line">  this.setState(&#123; editPost: post &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在原来的保存点击句柄，需要实现两个分支：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private handleSaveClick = () =&gt; &#123;</span><br><span class="line">  if (this.state.editPost.id) &#123;</span><br><span class="line">    // TODO - make a PUT request</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    axios</span><br><span class="line">      .post&lt;IPost&gt;( ... )</span><br><span class="line">      .then ( ... );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>实现<code>PUT</code>请求分支：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">if (this.state.editPost.id) &#123;</span><br><span class="line">  axios</span><br><span class="line">  .put&lt;IPost&gt;(</span><br><span class="line">    `https://jsonplaceholder.typicode.com/posts/$&#123;this.state.editPost.id&#125;`, this.state.editPost, &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ).then(() =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      editPost: &#123;</span><br><span class="line">        body: &quot;&quot;,</span><br><span class="line">        title: &quot;&quot;,</span><br><span class="line">        userId: 1</span><br><span class="line">      &#125;,</span><br><span class="line">      posts: this.state.posts</span><br><span class="line">        .filter(post =&gt; post.id !== this.state.editPost.id)</span><br><span class="line">        .concat(this.state.editPost)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="delete-data-with-axios">Delete data with axios</span></h3>
<p>添加<code>Delete</code>按钮以允许用户删除数据：</p>
<ol>
<li>首先创建一个<code>Delete</code>按钮：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;li key=&#123;post.id&#125;&gt;</span><br><span class="line">  &lt;h3&gt;&#123;post.title&#125;&lt;/h3&gt;</span><br><span class="line">  &lt;p&gt;&#123;post.body&#125;&lt;/p&gt;</span><br><span class="line">  &lt;button onClick=&#123;() =&gt; this.handleUpdateClick(post)&#125;&gt;</span><br><span class="line">    Update</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">  &lt;button onClick=&#123;() =&gt; this.handleDeleteClick(post)&#125;&gt;</span><br><span class="line">    Delete</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加删除的事件处理：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private handleDeleteClick = (post: IPost) =&gt; &#123;</span><br><span class="line">  axios</span><br><span class="line">  .delete(`https://jsonplaceholder.typicode.com/posts/$&#123;post.id&#125;`)</span><br><span class="line">  .then(() =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      posts: this.state.posts.filter(p =&gt; p.id !== post.id)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3><span id="using-axios-with-function-components">Using axios with function components</span></h3>
<p>本小节将实现函数组件(function component)版本的<code>axios</code>调用。我们将重构上一节的<code>App</code>的代码：</p>
<ol>
<li>首先声明<code>defaultPosts</code>常量，它包含了邮箱的初始状态。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const defaultPosts: IPost[] = [];</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>删除<code>IState</code>接口，因为状态被构造为独立的块。</li>
<li>移除先前的<code>App</code>类组件。</li>
<li>接下来，在常量<code>defaultPosts</code>下开始我们的<code>App</code>函数组件。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const App: React.FC = () =&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>下面创建独立的状态块，包括post、error、cancel token、loading falg、editpost。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const App: React.FC = () =&gt; &#123;</span><br><span class="line">  const [posts, setPosts]: [IPost[], (posts: IPost[]) =&gt; void] = React.useState(defaultPosts);</span><br><span class="line">  const [error, setError]: [string, (error: string) =&gt; void] = React.useState(&apos;&apos;);</span><br><span class="line">  const cancelToken = axios.CancelToken;</span><br><span class="line"></span><br><span class="line">  const [cancelTokenSource, setCancelTokenSource]: [</span><br><span class="line">    CancelTokenSource,</span><br><span class="line">    (cancelSourceToken: CancelTokenSource) =&gt; void,</span><br><span class="line">  ] = React.useState(cancelToken.source());</span><br><span class="line"></span><br><span class="line">  const [loading, setLoading]: [boolean, (loading: boolean) =&gt; void] = React.useState&lt;boolean&gt;(false);</span><br><span class="line">  const [editPost, setEditPost]: [IPost, (post: IPost) =&gt; void] = React.useState(&#123;</span><br><span class="line">    body: &apos;&apos;,</span><br><span class="line">    title: &apos;&apos;,</span><br><span class="line">    userId: 1,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，我们使用了<code>useState</code>函数来定义和初始化所有这些状态块。</p>
<ol start="6">
<li>我们希望在组件首次被挂载时调用REST API以获取邮箱信息。我们可以使用<code>useEffect</code>函数，在状态定义下添加：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">  // TODO - get posts</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>在arrow function调用REST API获取邮件数据：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">  axios</span><br><span class="line">  .get&lt;IPost[]&gt;(&quot;https://jsonplaceholder.typicode.com/posts&quot;, &#123;</span><br><span class="line">    cancelToken: cancelTokenSource.token,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      &quot;Content-Type&quot;: &quot;application/json&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    timeout: 5000</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>处理返回数据，设置邮箱数据和加载状态：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">  axios</span><br><span class="line">  .get&lt;IPost[]&gt;(...)</span><br><span class="line">	.then(response =&gt; &#123;</span><br><span class="line">    setPosts(response.data);</span><br><span class="line">    setLoading(false);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>处理错误状态信息：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">  axios</span><br><span class="line">    .get&lt;IPost[]&gt;(...)</span><br><span class="line">    .then(...)</span><br><span class="line">    .catch(ex =&gt; &#123;</span><br><span class="line">      const err = axios.isCancel(ex)</span><br><span class="line">        ? &apos;Request cancelled&apos;</span><br><span class="line">        : ex.code === &apos;ECONNABORTED&apos;</span><br><span class="line">        ? &apos;A timeout has occurred&apos;</span><br><span class="line">        : ex.response.status === 404</span><br><span class="line">        ? &apos;Resource not found&apos;</span><br><span class="line">        : &apos;An unexpected error has occurred&apos;;</span><br><span class="line">      setError(err);</span><br><span class="line">      setLoading(false);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>接下来处理事件。事件的处理并没有多大变化，只是使用<code>const</code>来声明，以及用前面声明的状态块来设置状态。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const handleCancelClick = () =&gt; &#123;</span><br><span class="line">  if (cancelTokenSource) &#123;</span><br><span class="line">    cancelTokenSource.cancel(&quot;User cancelled operation&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="11">
<li>输入变更事件：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const handleTitleChange = (e: React.ChangeEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">  setEditPost(&#123; ...editPost, title: e.currentTarget.value &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">const handleBodyChange = (e: React.ChangeEvent&lt;HTMLTextAreaElement&gt;) =&gt; &#123;</span><br><span class="line">  setEditPost(&#123; ...editPost, body: e.currentTarget.value &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="12">
<li><strong>Save</strong>按钮事件：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">const handleSaveClick = () =&gt; &#123;</span><br><span class="line">  if (editPost.id) &#123;</span><br><span class="line">    axios</span><br><span class="line">      .put&lt;IPost&gt;(`https://jsonplaceholder.typicode.com/posts/$&#123;editPost.id&#125;`, editPost, &#123;</span><br><span class="line">        headers: &#123;</span><br><span class="line">          &apos;Content-Type&apos;: &apos;application/json&apos;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(() =&gt; &#123;</span><br><span class="line">        setEditPost(&#123;</span><br><span class="line">          body: &apos;&apos;,</span><br><span class="line">          title: &apos;&apos;,</span><br><span class="line">          userId: 1,</span><br><span class="line">        &#125;);</span><br><span class="line">        setPosts(posts.filter(post =&gt; post.id !== editPost.id).concat(editPost));</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    axios</span><br><span class="line">      .post&lt;IPost&gt;(</span><br><span class="line">        &apos;https://jsonplaceholder.typicode.com/posts&apos;,</span><br><span class="line">        &#123;</span><br><span class="line">          body: editPost.body,</span><br><span class="line">          title: editPost.title,</span><br><span class="line">          userId: editPost.userId,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          headers: &#123;</span><br><span class="line">            &apos;Content-Type&apos;: &apos;application/json&apos;,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">      .then(response =&gt; &#123;</span><br><span class="line">        setPosts(posts.concat(response.data));</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="13">
<li><strong>Update</strong> 按钮：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const handleUpdateClick = (post: IPost) =&gt; &#123;</span><br><span class="line">  setEditPost(post);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="14">
<li><strong>Delete</strong>按钮：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const handleDeleteClick = (post: IPost) =&gt; &#123;</span><br><span class="line">  axios.delete(`https://jsonplaceholder.typicode.com/posts/$&#123;post.id&#125;`).then(() =&gt; &#123;</span><br><span class="line">    setPosts(posts.filter(p =&gt; p.id !== post.id));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="15">
<li>最后的任务是实现返回语句。和原来的没有太大改变，只是删掉了<code>this</code>引用。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">  &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">    &lt;div className=&quot;post-edit&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;text&quot; placeholder=&quot;Enter title&quot; value=&#123;editPost.title&#125; onChange=&#123;handleTitleChange&#125; /&gt;</span><br><span class="line">      &lt;textarea placeholder=&quot;Enter body&quot; value=&#123;editPost.body&#125; onChange=&#123;handleBodyChange&#125; /&gt;</span><br><span class="line">      &lt;button onClick=&#123;handleSaveClick&#125;&gt;Save&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &#123;loading &amp;&amp; &lt;button onClick=&#123;handleCancelClick&#125;&gt;Cancel&lt;/button&gt;&#125;</span><br><span class="line">    &lt;ul className=&quot;posts&quot;&gt;</span><br><span class="line">      &#123;posts.map(post =&gt; (</span><br><span class="line">        &lt;li key=&#123;post.id&#125;&gt;</span><br><span class="line">          &lt;h3&gt;&#123;post.title&#125;&lt;/h3&gt;</span><br><span class="line">          &lt;p&gt;&#123;post.body&#125;&lt;/p&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; handleUpdateClick(post)&#125;&gt;Update&lt;/button&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; handleDeleteClick(post)&#125;&gt;Delete&lt;/button&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &#123;error &amp;&amp; &lt;p className=&quot;error&quot;&gt;&#123;error&#125;&lt;/p&gt;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>主要不同的地方是，我们使用了<code>useEffect</code>函数来调用REST API，替换原来的<code>componentDidMount()</code>。</p>
<h2><span id="summary">Summary</span></h2>
<p>Callback-based异步代码难于阅读和维护。谁会花几个小时，从根节点开始去追踪Callback-based异步代码的bug呢？又或者花好几个小时来逐步理解每个回调的意思？幸运的是，我们有Promise-based的写法。</p>
<p>Promise-based函数相比基于回调的写法有很大提升。更易于阅读、错误更易处理。结合关键字<code>async</code>和<code>await</code>后的使用相比原来代码有更大的阅读性。</p>
<p>现代浏览器有一个很好的<code>fetch</code>函数来处理REST请求。它是一个Promise-based的函数，提供对异步请求很好的处理。</p>
<p><code>axios</code>是相对<code>fetch</code>的另一种选择。它的API更清晰，TypeScript更友好，错误处理更方便。</p>
<p>最后我们还对异步请求的实现做了两个不同的版本。一个是class component，另一个是function component(FC)。在类组件，异步的处理要放在<code>componentDidMount</code>生命周期函数中。在函数组件，使用<code>useEffect</code>函数来处理每次的渲染。两种方式，你会选择哪种？</p>
<p>REST API并不是唯一会交互的API。GraphQL是另一种流行的API服务。将在下个章节学习。</p>
<h2><span id="questions">Questions</span></h2>
<p>问题时间。</p>
<ol>
<li>下面程序执行后，会在console输出什么？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    setInterval(() =&gt; &#123;</span><br><span class="line">        throw new Error(&quot;Oops&quot;);</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">&#125; catch (ex) &#123;</span><br><span class="line">    console.log(&quot;Sorry, there is a problem&quot;, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>假设没有9999这个邮箱，下面程序会输出什么？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fetch(&quot;https://jsonplaceholder.typicode.com/posts/999&quot;)</span><br><span class="line">.then(response =&gt; &#123;</span><br><span class="line">    console.log(&quot;HTTP status code&quot;, response.status);</span><br><span class="line">    return response.json();</span><br><span class="line">&#125;)</span><br><span class="line">.then(data =&gt; console.log(&quot;Response body&quot;, data))</span><br><span class="line">.catch(error =&gt; console.log(&quot;Error&quot;, error));</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>下面程序执行后，console会输出什么？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">.get(&quot;https://jsonplaceholder.typicode.com/posts/9999&quot;)</span><br><span class="line">.then(response =&gt; &#123;</span><br><span class="line">    console.log(&quot;HTTP status code&quot;, response.status);</span><br><span class="line">&#125;)</span><br><span class="line">.catch(error =&gt; &#123;</span><br><span class="line">    console.log(&quot;Error&quot;, error.response.status);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>使用<code>fetch</code>和<code>axios</code>有什么好处？</li>
<li>下面程序如何添加一个bearer token？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.get(&quot;https://jsonplaceholder.typicode.com/posts/1&quot;)</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>我们使用下面程序来更新邮箱的标题？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">axios.put(&quot;https://jsonplaceholder.typicode.com/posts/1&quot;, &#123;</span><br><span class="line">    title: &quot;corrected title&quot;,</span><br><span class="line">    body: &quot;some stuff&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>如果要用到<code>PATCH</code>请求，怎么改更高效。</li>
<li>我们实现了一个FC来显示邮箱，下面代码在执行时会有什么错误？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">    axios</span><br><span class="line">    .get(`https://jsonplaceholder.typicode.com/posts/$&#123;id&#125;`)</span><br><span class="line">    .then(...)</span><br><span class="line">    .catch(...);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</div></article><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/11/27/react-ts/chapter_9_Interacting_with_RESTful_APIs/';
var disqus_title = '第九章 RESTful 接口交互';
var disqus_url = 'http://galudisu.info/2019/11/27/react-ts/chapter_9_Interacting_with_RESTful_APIs/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//barudisshu-github-io.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2020 <a href="http://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready"><script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css"><script src="/js/base.js"></script><script src="/js/rabbit-lyrics.js"></script></div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --></body></html>
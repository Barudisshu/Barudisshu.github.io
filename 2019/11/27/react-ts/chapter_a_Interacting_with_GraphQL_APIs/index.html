<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第十章 GraphQL接口交互</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第十章 GraphQL接口交互</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-11-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tags"> </i><a class="tag-link" href="/tags/react/">react<span class="tag">, </span></a><a class="tag-link" href="/tags/typescript/">typescript</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/react/">react</a></p></div><div class="article-content"><ul>
<li>GraphQL query and mutation syntax</li>
<li>Using axios as a GraphQL client</li>
<li>Using Apollo GraphQL client</li>
<li>Working with cached data in Apollo</li>
</ul>
<p>GraphQL很少被用到，本章仅作简单介绍和使用。</p>
<span id="more"></span>
<p>GraphQL是由Facebook开源的web API数据读写语言。它允许客户端，在一个请求中返回指定的数据内容。</p>
<h2><span id="graphql-query-and-mutation-syntax">GraphQL query and mutation syntax</span></h2>
<p>首先介绍一下语法。</p>
<h3><span id="reading-graphql-data">Reading GraphQL data</span></h3>
<h3><span id="basic-query">Basic query</span></h3>
<ol>
<li>首先打开 .</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.github.com/v4/explorer/</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>输入下面内容并执行 .</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  viewer &#123;</span><br><span class="line">  name</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>query</code>关键字开启了查询，它是可选的。</li>
<li><code>viewer</code>是我们需要获取的对象。</li>
<li><code>name</code>为<code>viewer</code>的名字，作为返回。</li>
</ul>
<p>执行后返回的是JSON对象。</p>
<ol start="3">
<li>我们可以从结果部分查看文档说明。</li>
<li>从文档得知，我们还可以添加额外的查询字段：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  viewer &#123;</span><br><span class="line">  name</span><br><span class="line">  avatarUrl</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="returning-nested-data">Returning nested data</span></h3>
<p>复杂一点，我们希望查询github的start和issue的数量并返回。</p>
<ol>
<li>首先输入下面查询：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  repository(owner:<span class="string">&quot;facebook&quot;</span>, name: <span class="string">&quot;react&quot;</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次传递了两个参数，查找<code>owner</code>为Facebook，name为react的仓储.以及将 name 和 description作为返回值。</p>
<ol start="2">
<li>下面希望获取得到star的数量。</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  repository(owner:<span class="string">&quot;facebook&quot;</span>,name:<span class="string">&quot;react&quot;</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    stargazers &#123;</span><br><span class="line">      totalCount</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>指定别名：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stargazers &#123;</span><br><span class="line">  stars:totalCount</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行查询语句后，可以看到返回的star已被别名代替：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">             <span class="attr">&quot;repository&quot;</span>: &#123;</span><br><span class="line">               <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;react&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;A declarative, efficient, and flexible</span></span><br><span class="line"><span class="string">JavaScript library for building user interfaces.&quot;</span>, <span class="attr">&quot;stargazers&quot;</span>: &#123;</span><br><span class="line"><span class="attr">&quot;stars&quot;</span>: <span class="number">114998</span> &#125;</span><br><span class="line">&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>查找最近的5个issues信息，</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  repository(owner: <span class="string">&quot;facebook&quot;</span>, name:<span class="string">&quot;react&quot;</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    stargazers &#123;</span><br><span class="line">      stars:totalCount</span><br><span class="line">    &#125;</span><br><span class="line">    issues(last: <span class="number">5</span>) &#123;</span><br><span class="line">      edges &#123;</span><br><span class="line">        node &#123;</span><br><span class="line">          id</span><br><span class="line">          title</span><br><span class="line">          url</span><br><span class="line">          publishedAt</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的查询用<code>edges</code>和<code>node</code>包装了结构，用于cursor-based的分页。</p>
<h3><span id="query-parameters">Query parameters</span></h3>
<p>前面的查询是以硬编码的方式，我们希望定义变量查询。</p>
<ol>
<li>我们可以在<code>query</code>关键字后面添加查询变量。这些参数需要声明它的类型、变量名。其中变量名要以<code>$</code>开头。类型后要带<code>!</code>。如下：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query ($org: String!, $repo: String!) &#123;</span><br><span class="line">  repository(owner:$org, name:$repo) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在执行之前，我们需要在<strong>Query Variables</strong>面板添加变量入参：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;org&quot;</span>: <span class="string">&quot;facebook&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;repo&quot;</span>: <span class="string">&quot;react&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="writing-graphql-data">Writing GraphQL data</span></h3>
<p>GraphQL的数据写入需要创建<code>mutation</code>。</p>
<ol>
<li>要给github的repo加星，首先需要获得<code>id</code>.</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query($org: String!, $repo: String!) &#123;</span><br><span class="line">  repository(owner:$org, name:$repo) &#123;</span><br><span class="line">    id</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将上面查询的返回<code>id</code>拷贝，该<code>id</code>格式如下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MDEwOlJlcG9zaXRvcnkxMDI3MDI1MA==</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建第一个<code>mutation</code>：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mutation ($repoId: ID!) &#123;</span><br><span class="line">  addStar(input: &#123; starrableId: $repoId &#125;) &#123;</span><br><span class="line">  starrable &#123;</span><br><span class="line">  stargazers &#123;</span><br><span class="line">  totalCount</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>数据变更开始于<code>mutation</code>关键字</li>
<li>参数可以放在括号内</li>
<li><code>addStar</code>是一个<code>mutation</code>函数，包含一个<code>input</code>参数</li>
<li><code>input</code>实际上是一个对象，包含字段<code>starrabledId</code>，即我们需要星标的id，这里传入了<code>$repoId</code></li>
<li>之后我们指定了它的返回内容</li>
</ul>
<ol start="4">
<li>在<strong>Query Variables</strong>面板填入参数：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;repoId&quot;</span>: <span class="string">&quot;MDEwOlJlcG9zaXRvcnkxMDI3MDI1MA==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>执行之后发现star数增加了</li>
</ol>
<h2><span id="using-axios-as-a-graphql-client">Using axios as a GraphQL client</span></h2>
<h3><span id="getting-a-github-personal-access-token">Getting a GitHub personal access token</span></h3>
<p>在此之前，首先需要到GitHub获取一个token。</p>
<h3><span id="creating-our-app">Creating our app</span></h3>
<p>(略)</p>
<h3><span id="querying-the-graphql-server">Querying the GraphQL server</span></h3>
<p>现在有了TypeScript版的React应用了，下面使用<code>axios</code>来进行GraphQL的查询：</p>
<ol>
<li>在<code>Header.tsx</code>，创建两个接口表示GraphQL查询的返回数据：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface IViewer &#123;</span><br><span class="line">    name: string;</span><br><span class="line">    avatarUrl: string;</span><br><span class="line">&#125;</span><br><span class="line">interface IQueryResult &#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">        viewer: IViewer;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在<code>Header</code>组件创建一些状态块：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const [viewer, setViewer]: [IViewer, (viewer: IViewer) =&gt; void] = React.useState(&#123;name: &quot;&quot;, avatarUrl: &quot;&quot;&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在组件被挂载时声明周期中开始GraphQL的查询。我们使用了<code>useEffect</code>函数：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">    // TODO - make a GraphQL query</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<p>第二个参数使用了一个空数组，这样仅在组件被挂载时进行查询，而不是每次都查询。</p>
<ol start="4">
<li>然后使用<code>axios</code>进行GraphQL的查询操作：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">React.useEffect(() =&gt; &#123;</span><br><span class="line">    axios.post&lt;IQueryResult&gt;(&quot;https://api.github.com/graphql&quot;, &#123;</span><br><span class="line">        query: `query &#123;</span><br><span class="line">			viewer &#123;</span><br><span class="line">				name</span><br><span class="line">				avatarUrl</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;`</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<p>GraphQL要求使用HTTP <code>POST</code>方法，因为查询语句在方法体内。</p>
<ol start="5">
<li>另外还需要在标头带上bearer token进行认证。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">axios.post&lt;IQueryResult&gt;(</span><br><span class="line">  &#x27;https://api.github.com/graphql&#x27;,</span><br><span class="line">  &#123;</span><br><span class="line">    query: `query &#123;</span><br><span class="line">      viewer &#123;</span><br><span class="line">      name</span><br><span class="line">      avatarUrl</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;`</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      Authorization: &#x27;bearer our-bearer-token&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这里 token用前面申请的真实token。</p>
<ol start="6">
<li>现在还没有对返回内容做处理，因此：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">axios.post&lt;IQueryResult&gt;(</span><br><span class="line">  ...,</span><br><span class="line">).then(response =&gt; &#123;</span><br><span class="line">  setViewer(response.data.data.viewer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>现在数据已经存入了state，对页面内容渲染即可：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;img src=&#123;viewer.avatarUrl&#125; className=&quot;avatar&quot; /&gt;</span><br><span class="line">    &lt;div className=&quot;viewer&quot;&gt;&#123;viewer.name&#125;&lt;/div&gt;</span><br><span class="line">    &lt;h1&gt;GitHub Search&lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>添加一些样式到<code>App.css</code>:</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">60px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到运行的页面，可以看到我们的头像和标题。</p>
<p>我们发现，所有的GraphQL的请求都是HTTP POST，所有请求都指向同一个地址，请求的参数不是在URL地址，而是来源于请求体。因此，当我们使用诸如<code>axios</code>这种HTTP标准库会觉得怪怪的。</p>
<p>我们希望有一种更自然的方式。</p>
<h2><span id="using-apollo-graphql-client">Using Apollo GraphQL client</span></h2>
<p>Apollo是一个用于交互GraphQL服务端的客户端库。相比<code>axios</code>它有更多的优势，譬如对数据的读写缓存。</p>
<h3><span id="installing-apollo-client">Installing Apollo client</span></h3>
<ol>
<li>首先安装相应的包：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install apollo-boost react-apollo graphql</span><br></pre></td></tr></table></figure>
<ul>
<li><code>apollo-boost</code>包含了Apollo客户端的所有内容</li>
<li><code>react-apollo</code>包含有用于交互GraphQL服务的React 组件</li>
<li><code>graphql</code>是个用于解析GraphQL查询的核心包</li>
</ul>
<ol start="2">
<li>另外需要安装一些TypeScript的类型：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @types/graphql --save-dev</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>还需要确保编译时，应该包含<code>es2015</code>和<code>esNext</code>的依赖库。在<code>tsconfig.json</code>添加<code>lib</code>中:</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lib&quot;</span>: [<span class="string">&quot;es2015&quot;</span>, <span class="string">&quot;dom&quot;</span>, <span class="string">&quot;esnext&quot;</span>],</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="migrating-from-axios-to-apollo">Migrating from axios to Apollo</span></h3>
<p>迁移到apollo上。</p>
<h3><span id="adding-an-apollo-provider">Adding an Apollo provider</span></h3>
<p>首先从<code>App.tsx</code>入手，将会定义我们的Apollo客户端，并_提供_给<code>App</code>所有子组件下使用。</p>
<ol>
<li>在<code>App.tsx</code>，导入依赖：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import ApolloClient from &quot;apollo-boost&quot;；</span><br><span class="line">import&#123; ApolloProvider &#125; from &quot;react-apollo&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在<code>App</code>类组件前面，创建客户端<code>ApolloClient</code>：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const client = new ApolloClient(&#123;</span><br><span class="line">    uri: &quot;https://api.github.com/graphql&quot;,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        authorization: `Bearer our-bearer-token`</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>最后一步是使用<code>ApolloProvider</code>组件并传入<code>ApolloClient</code>参数即可。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public render() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;ApolloProvider client=&#123;client&#125;&gt;</span><br><span class="line">      &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">        &lt;header className=&quot;App-header&quot;&gt;</span><br><span class="line">          &lt;Header /&gt;</span><br><span class="line">        &lt;/header&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/ApolloProvider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在<code>ApolloClient</code>已经设置好了，下面开始交互内容。</p>
<h3><span id="using-the-query-component-to-query-graphql">Using the query component to query GraphQL</span></h3>
<p>我们现在使用<code>Query</code>组件来获取GitHub的名字和头像，替换掉<code>axios</code>代码：</p>
<ol>
<li>导入下面依赖，并删掉原来的<code>axios</code>：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import gql from &quot;graphql-tag&quot;;</span><br><span class="line">import &#123; Query &#125; from &quot;react-apollo&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>IViewer</code>接口内容保留，但需要和<code>IQueryResult</code>拧在一起：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface IQueryResult &#123;</span><br><span class="line">    viewer: IViewer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义查询：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const GET_VIEWER = gql`</span><br><span class="line">&#123;</span><br><span class="line">  viewer &#123;</span><br><span class="line">    name</span><br><span class="line">    avatarUrl</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>我们字面量声明了<code>GET_VIEWER</code>查询。在前面带有<code>gql</code>看起来有些古怪。这个模板字面量不应该用括号吗？实际上<code>gql</code>是一个函数，它会解析该函数后面的查询语句。</p>
<ol start="4">
<li>为了Type safety，创建一个新的组件<code>GetViewerQuery</code>，并定义结果的返回类型：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class GetViewerQuery extends Query&lt;IQueryResult&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>我们不再需要状态，因此移除<code>viewer</code>和<code>setViewer</code>变量。</li>
<li>因为不需要<code>axios</code>查询了，<code>useEffect</code>也删掉。</li>
<li>我们使用<code>GetViewerQuery</code>组件进行查询：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">  &lt;GetViewerQuery query=&#123;GET_VIEWER&#125;&gt;</span><br><span class="line">    &#123;(&#123;data&#125;) =&gt; &#123;</span><br><span class="line">      if (!data || !data.viewer) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      return (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;img src=&#123;data.viewer.avatarUrl&#125; className=&quot;avatar&quot;  alt=&#123;&quot;avatar&quot;&#125;/&gt;</span><br><span class="line">          &lt;div className=&quot;viewer&quot;&gt;&#123;data.viewer.name&#125;&lt;/div&gt;</span><br><span class="line">          &lt;h1&gt;GitHub Search&lt;/h1&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  &lt;/Query&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>如果我们希望获取其它信息内容。例如查询数据是否正在加载中。可以改为：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">    &lt;GetViewerQuery query=&#123;GET_VIEWER&#125;&gt;</span><br><span class="line">        &#123;(&#123; data, loading&#125;) =&gt; &#123;</span><br><span class="line">            if (loading) &#123;</span><br><span class="line">                return &lt;div className=&quot;viewer&quot;&gt;Loading...&lt;/div&gt;;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    &lt;/GetViewerQuery&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>又或者想要获取错误信息：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">    &lt;GetViewerQuery query=&#123;GET_VIEWER&#125;&gt;</span><br><span class="line">        &#123;(&#123; data, loading, error&#125;) =&gt; &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                return &lt;div className=&quot;viewer&quot;&gt;&#123;error.toString()&#125;&lt;/div&gt;;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    &lt;/GetViewerQuery&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Apollo的实现非常优雅。它可以确保<code>Query</code>组件在正确的位置获取得到对应的数据。</p>
<h3><span id="adding-a-repository-search-component">Adding a repository search component</span></h3>
<p>根据已有的查询功能，我们希望有一个搜索repository的选框。</p>
<ol>
<li>首先创建一个<code>RepoSearch.tsx</code>，导入相应的依赖：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import * as React from &quot;react&quot;;</span><br><span class="line">import gql from &quot;graphql-tag&quot;;</span><br><span class="line">import &#123; ApolloClient &#125; from &quot;apollo-boost&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>由于需要带入<code>ApolloClient</code>作为prop，添加一个接口实现：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface IProps &#123;</span><br><span class="line">    client: ApolloClient&lt;any&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>架设组件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const RepoSearch: React.FC&lt;IProps&gt; = props =&gt; &#123;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line">export default RepoSearch;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>导入的<code>App.tsx</code>：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import RepoSearch from &quot;./RepoSearch&quot;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加到<code>ApolloClient</code>下面：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;ApolloProvider client=&#123;client&#125;&gt;</span><br><span class="line">  &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">    &lt;header className=&quot;App-header&quot;&gt;</span><br><span class="line">      &lt;Header /&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">    &lt;RepoSearch client=&#123;client&#125; /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/ApolloProvider&gt;</span><br></pre></td></tr></table></figure>
<h3><span id="implementing-the-search-form">Implementing the search form</span></h3>
<p>实现一个表单，允许用户输入组织名和仓储名：</p>
<ol>
<li>在<code>RepoSearch.tsx</code>，定义搜索字段接口：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface ISearch &#123;</span><br><span class="line">    orgName: string;</span><br><span class="line">    repoName: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建一个变量来装载<code>search</code>状态，</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const RepoSearch: React.SFC&lt;IProps&gt; = props =&gt; &#123;</span><br><span class="line">    const [search, setSearch]: [ISearch, (search: ISearch) =&gt; void] = React.useState(&#123;orgName: &quot;&quot;, repoName: &quot;&quot;&#125;);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义<code>search</code>表单：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">&lt;div className=&quot;repo-search&quot;&gt;</span><br><span class="line">  &lt;form onSubmit=&#123;handleSearch&#125;&gt;</span><br><span class="line">    &lt;label&gt;Organization&lt;/label&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; onChange=&#123;handleOrgNameChange&#125; value=&#123;search.orgName&#125; /&gt;</span><br><span class="line">    &lt;label&gt;Repository&lt;/label&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; onChange=&#123;handleRepoNameChange&#125; value=&#123;search.repoName&#125; /&gt;</span><br><span class="line">    &lt;button type=&quot;submit&quot;&gt;Search&lt;/button&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>添加样式：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.repo-search</span> <span class="selector-tag">label</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">3px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.repo-search</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#676666</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.repo-search</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>实现表单事件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const handleOrgNameChange = (e: React.ChangeEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">  setSearch(&#123;...search, orgName: e.currentTarget.value&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const handleRepoNameChange = (e: React.ChangeEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">  setSearch(&#123;...search, repoName: e.currentTarget.value&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>最后一个操作是实现<code>search</code>的处理：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  // TODO - make GraphQL query</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>至此，表单的创建已经完成。</p>
<h3><span id="implementing-the-search-query">Implementing the search query</span></h3>
<p>现在的关键问题是，如何查询。</p>
<ol>
<li>首先创建返回接口：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">interface IRepo &#123;</span><br><span class="line">  id: string;</span><br><span class="line">  name: string;</span><br><span class="line">  description: string;</span><br><span class="line">  viewerHasStarred: boolean;</span><br><span class="line">  stargazers: &#123;</span><br><span class="line">    totalCount: number;</span><br><span class="line">  &#125;;</span><br><span class="line">  issues: &#123;</span><br><span class="line">    edges: [</span><br><span class="line">      &#123;</span><br><span class="line">        node: &#123;</span><br><span class="line">          id: string;</span><br><span class="line">          title: string;</span><br><span class="line">          url: string;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;,</span><br><span class="line">    ];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该结构跟GitHub GraphQL Explorer的返回一样。</p>
<ol start="2">
<li>需要一个默认的初始化值：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const defaultRepo: IRepo = &#123;</span><br><span class="line">  id: &#x27;&#x27;,</span><br><span class="line">  name: &#x27;&#x27;,</span><br><span class="line">  description: &#x27;&#x27;,</span><br><span class="line">  viewerHasStarred: false,</span><br><span class="line">  stargazers: &#123;</span><br><span class="line">    totalCount: 0,</span><br><span class="line">  &#125;,</span><br><span class="line">  issues: &#123;</span><br><span class="line">    edges: [</span><br><span class="line">      &#123;</span><br><span class="line">        node: &#123;</span><br><span class="line">          id: &#x27;&#x27;,</span><br><span class="line">          title: &#x27;&#x27;,</span><br><span class="line">          url: &#x27;&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义查询结果接口：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface IQueryResult &#123;</span><br><span class="line">    repository: IRepo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>创建查询模板字面量(tagged template literal)：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const GET_REPO = gql`</span><br><span class="line">  query GetRepo($orgName: String!, $repoName: String!) &#123;</span><br><span class="line">    repository(owner: $orgName, name: $repoName) &#123;</span><br><span class="line">      id</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">      viewerHasStarred</span><br><span class="line">      stargazers &#123;</span><br><span class="line">        totalCount</span><br><span class="line">      &#125;</span><br><span class="line">      issues(last: 5) &#123;</span><br><span class="line">        edges &#123;</span><br><span class="line">          node &#123;</span><br><span class="line">            id</span><br><span class="line">            title</span><br><span class="line">            url</span><br><span class="line">            publishedAt</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<p>不同的是，此次查询带有参数。</p>
<ol start="5">
<li>另外需要存储返回的数据到状态中。因此创建变量<code>repo</code>，</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const [repo, setRepo]: [IRepo, (repo: IRepo) =&gt; void] = React.useState(defaultRepo);</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>存储一些错误信息：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const [searchError, setSearchError]: [string, (searchError: string) =&gt; void] = React.useState(&quot;&quot;);</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>更新<code>handleSearch</code>箭头函数，</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">e.preventDefault();</span><br><span class="line">setSearchError(&quot;&quot;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>传入<code>ApolloClient</code>进行查询：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line">  setSearchError(&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">  props.client</span><br><span class="line">    .query&lt;IQueryResult&gt;(&#123;</span><br><span class="line">      query: GET_REPO</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="9">
<li>将参数传入给query语句：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line">  setSearchError(&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">  props.client</span><br><span class="line">    .query&lt;IQueryResult&gt;(&#123;</span><br><span class="line">      query: GET_REPO,</span><br><span class="line">      variables: &#123;orgName: search.orgName, repoName: search.repoName&#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="10">
<li>处理返回内容：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line">  setSearchError(&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">  props.client</span><br><span class="line">    .query&lt;IQueryResult&gt;(...)</span><br><span class="line">    .then(response =&gt; &#123;</span><br><span class="line">      setRepo(response.data.repository);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="11">
<li>处理异常信息：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const handleSearch = (e: React.FormEvent&lt;HTMLFormElement&gt;) =&gt; &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line">  setSearchError(&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">  props.client</span><br><span class="line">    .query&lt;IQueryResult&gt;(...)</span><br><span class="line">    .then(...)</span><br><span class="line">    .catch(error =&gt; &#123;</span><br><span class="line">      setSearchError(error.message);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3><span id="rendering-the-result">Rendering the result</span></h3>
<p>既然数据已经获取到了，需要将数据展现出来：</p>
<ol>
<li>渲染github点赞部分：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=&quot;repo-search&quot;&gt;</span><br><span class="line">  &lt;form ...&gt;</span><br><span class="line">      ...</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">  &#123;repo.id &amp;&amp; (</span><br><span class="line">    &lt;div className=&quot;repo-item&quot;&gt;</span><br><span class="line">      &lt;h4&gt;</span><br><span class="line">        &#123;repo.name&#125;</span><br><span class="line">        &#123;repo.stargazers ? ` $&#123;repo.stargazers.totalCount&#125; stars` : &#x27;&#x27;&#125;</span><br><span class="line">      &lt;/h4&gt;</span><br><span class="line">      &lt;p&gt;&#123;repo.description&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>渲染repository的列表：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;p&gt;&#123;repo.description&#125;&lt;/p&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    Last 5 issues:</span><br><span class="line">    &#123;repo.issues &amp;&amp; repo.issues.edges ? (</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;repo.issues.edges.map(item =&gt; (</span><br><span class="line">          &lt;li key=&#123;item.node.id&#125;&gt;&#123;item.node.title&#125;&lt;/li&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    ) : null&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>显示错误信息：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  &#123;repo.id &amp;&amp; (</span><br><span class="line">   ...</span><br><span class="line">  &#123;searchError &amp;&amp; &lt;div&gt;&#123;searchError&#125;&lt;/div&gt;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>添加<code>App.css</code>样式：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.repo-search</span> <span class="selector-tag">h4</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="implementing-a-mutation-with-apollo">Implementing a mutation with Apollo</span></h3>
<p>我们可以在React中使用GraphQL的<code>mutation</code>。</p>
<ol>
<li>首先导入<code>Mutation</code>组件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Mutation &#125; from &quot;react-apollo&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建<code>mutation</code>的查询：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const STAR_REPO = gql`</span><br><span class="line">  mutation($repoId: ID!) &#123;</span><br><span class="line">    addStar(input: &#123;starrableId: $repoId&#125;) &#123;</span><br><span class="line">      starrable &#123;</span><br><span class="line">        stargazers &#123;</span><br><span class="line">          totalCount</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在渲染代码部分，加入<code>Mutation</code>组件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;repo.description&#125;&lt;/p&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &#123;!repo.viewerHasStarred &amp;&amp; (</span><br><span class="line">    &lt;Mutation mutation=&#123;STAR_REPO&#125;</span><br><span class="line">              variables=&#123;&#123; repoId: repo.id &#125;&#125;</span><br><span class="line">              &gt;</span><br><span class="line">      &#123;() =&gt; (</span><br><span class="line">        // render Star button that invokes the mutation when clicked</span><br><span class="line">      )&#125;</span><br><span class="line">    &lt;/Mutation&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  Last 5 issues:</span><br></pre></td></tr></table></figure>
<ul>
<li>对<code>mutation</code>的渲染在<code>viewer</code>没有被点赞的repo</li>
<li><code>Mutation</code>组件接收repository 的<code>id</code>作为入参</li>
</ul>
<ol start="4">
<li><code>Mutation</code>组件有一个子函数<code>addStar</code>允许我们访问点赞数。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;Mutation</span><br><span class="line">    ...</span><br><span class="line">    &gt;</span><br><span class="line">    &#123;(addStar) =&gt; (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;button onClick=&#123;() =&gt; addStar()&#125;&gt;</span><br><span class="line">                Star!</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    )&#125;</span><br><span class="line">&lt;/Mutation&gt;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>loading</code>属性作为第二参数：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;Mutation</span><br><span class="line">...</span><br><span class="line">&gt;</span><br><span class="line">&#123;(addStar, &#123; loading &#125;) =&gt; (</span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;button disabled=&#123;loading&#125; onClick=&#123;() =&gt; addStar()&#125;&gt;</span><br><span class="line">&#123;loading ? &quot;Adding ...&quot; : &quot;Star!&quot;&#125;</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">)&#125;</span><br><span class="line">&lt;/Mutation&gt;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>处理错误信息：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;(addStar, &#123; loading, error&#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button disabled=&#123;loading&#125; onClick=&#123;() =&gt; addStar()&#125;&gt;</span><br><span class="line">      &#123;loading? &quot;Adding ...&quot;: &quot;Star!&quot;&#125;</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">    &#123;error &amp;&amp; &lt;div&gt;&#123;error.toString()&#125;&lt;/div&gt;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="working-with-cached-data-in-apollo">Working with cached data in Apollo</span></h2>
<p>前面发现点击按钮后，数据并没有刷新，需要清理掉浏览器的缓存数据。</p>
<h3><span id="clearing-the-caching-using-refetchqueries">Clearing the caching using refetchQueries</span></h3>
<p>每次发生<code>mutation</code>操作时，需要清理掉缓存信息。一种方式是使用<code>refetchQueries</code>：</p>
<ol>
<li><code>refetchQueries</code>接收一个数组对象，该对象的查询变量会被从缓存中删除。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;Mutation</span><br><span class="line">  mutation=&#123;STAR_REPO&#125;</span><br><span class="line">  variables=&#123;&#123;repoId: repo.id&#125;&#125;</span><br><span class="line">  refetchQueries=&#123;[</span><br><span class="line">    &#123;</span><br><span class="line">      query: GET_REPO,</span><br><span class="line">      variables: &#123;</span><br><span class="line">        orgName: search.orgName,</span><br><span class="line">        repoName: search.repoName,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]&#125;&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>如果给一个repo点赞，点赞的数字并没有立即更新。然而，点击<code>Search</code>按钮后才更新。</li>
</ol>
<p>因此，数据也并没有立即更新，这种方式也不是很好，用户体验不太理想。</p>
<h3><span id="updating-the-cache-after-a-mutation">Updating the cache after a Mutation</span></h3>
<p>幸运的是，<code>Mutation</code>组件还有另外一个方法<code>update</code>，我们可以对缓存信息进行更新。</p>
<ol>
<li>删掉之前的<code>refetchQueries</code>。</li>
<li>实现<code>update</code>操作：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Mutation</span><br><span class="line">    mutation=&#123;STAR_REPO&#125;</span><br><span class="line">    udpate=&#123;cache=&gt; &#123;</span><br><span class="line">        // Get the cached data</span><br><span class="line">        // update the cached data</span><br><span class="line">        // update our state</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>更新缓存：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;Mutation</span><br><span class="line">    ...</span><br><span class="line">    update=&#123;cache =&gt; &#123;</span><br><span class="line">        const data: &#123; repository: IRepo &#125; | null = cache.readQuery(&#123;</span><br><span class="line">            query: GET_REPO,</span><br><span class="line">            variables: &#123;</span><br><span class="line">                orgName: search.orgName,</span><br><span class="line">                repoName: search.repoName</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        if (data === null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有缓存数据，我们直接return，不做任何处理。</p>
<ol start="4">
<li>现在有了一份来自缓存的数据了，直接对这份数据操作。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">update=&#123;cache =&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">        if (data === null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">	const newData = &#123;</span><br><span class="line">        ...data.repository,</span><br><span class="line">        viewerHasStarred: true,</span><br><span class="line">        stargazers: &#123;</span><br><span class="line">            ...data.repository.stargazers,</span><br><span class="line">            totalCount: data.repository.stargazers.totalCount + 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">       &#125;&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>然后使用<code>writeQuery</code>函数来更新缓存信息。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">update=&#123;cache =&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">        const newData=&#123;</span><br><span class="line">        ...</span><br><span class="line">       &#125;;</span><br><span class="line">cache.writeQuery(&#123;</span><br><span class="line">    query: GET_REPO,</span><br><span class="line">    variable: &#123;</span><br><span class="line">        orgName: search.orgName,</span><br><span class="line">        repoName: search.repoName,</span><br><span class="line">    &#125;,</span><br><span class="line">    data: &#123; repository: newData &#125;</span><br><span class="line">&#125;)</span><br><span class="line">       &#125;&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>最后一步是更新本地的state数据：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">update=&#123;cache =&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">        cache.writeQuery(...);</span><br><span class="line">		setRepo(newData);</span><br><span class="line">       &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当给某个repo点赞，可以看到数据立即刷新了。</p>
<h2><span id="summary">Summary</span></h2>
<p>GraphQL目前不是很少用，虽然某些情况下很灵活，提供了树形结构的数据。查询和返回结构一致。只有一个请求地址。请求方法只有一个POST。查询参数灵活多变。</p>
<p>这里还介绍了<code>Apollo</code>客户端的实现，相比于<code>axios</code>。只需要在顶层组件实现一个<code>provider</code>即可，类似于Router的实现。</p>
<p>还介绍了<code>Mutation</code>组件的实现，以及对内存的处理。</p>
<p>不常用的原因也可想而知，不便于维护，没有版本，对于简单的接口来说有点臃肿。</p>
<p>鉴于GraphQL很少出现，此处不作习题演练。</p>
</div></article><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/11/27/react-ts/chapter_a_Interacting_with_GraphQL_APIs/';
var disqus_title = '第十章 GraphQL接口交互';
var disqus_url = 'http://galudisu.info/2019/11/27/react-ts/chapter_a_Interacting_with_GraphQL_APIs/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2021 <a href="http://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>